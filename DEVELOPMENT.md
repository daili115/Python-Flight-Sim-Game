# 3D飞行模拟游戏开发指南

## 1. 项目架构概览

本项目采用模块化设计，将渲染、物理、控制和游戏逻辑分离，以提高可维护性和可扩展性。

| 模块 | 文件 | 职责 |
| :--- | :--- | :--- |
| **渲染/主循环** | `src/main.py` | 初始化 Panda3D 引擎、场景、光照、HUD 和主游戏循环。 |
| **物理引擎** | `src/physics_manager.py` | 集成 PyBullet，实现简化的六自由度 (6-DOF) 飞行动力学模型。 |
| **飞行控制** | `src/aircraft_controller.py` | 处理用户输入、更新控制面状态、管理多视角切换。 |
| **游戏逻辑** | `src/game_manager.py` | 实现任务系统（检查点）、计分机制和游戏状态管理。 |

## 2. 3D建模规范

所有 3D 资源应使用 **Blender** 创建，并遵循以下规范以确保在 Panda3D 和物理引擎中的正确集成。

### 2.1. 飞行器模型规范

| 规范项 | 要求 | 目的 |
| :--- | :--- | :--- |
| **模型格式** | 推荐 `.gltf` 或 `.egg` | Panda3D 推荐格式，支持 PBR 材质和动画。 |
| **坐标系** | **Y 轴向前，Z 轴向上，X 轴向右** | 统一坐标系，与 Panda3D 默认坐标系保持一致。 |
| **机身结构** | 必须是单个网格，但可动部件应分离。 | 优化渲染批次，简化物理刚体创建。 |
| **可动控制面** | **襟翼 (Flaps)**, **副翼 (Ailerons)**, **方向舵 (Rudder)**, **升降舵 (Elevator)** 必须是独立的网格，并以正确的轴心点进行父级绑定。 | 允许通过代码控制其旋转和动画。 |
| **材质贴图** | 必须使用 PBR (Physically Based Rendering) 流程：`Albedo/BaseColor`, `Normal`, `Metallic`, `Roughness`, `Ambient Occlusion`。 | 实现真实的材质光影效果。 |
| **LOD** | 必须提供至少 3 个级别的 LOD 模型：`_high`, `_med`, `_low`。 | 配合 Panda3D 的 `LODNode` 实现性能优化。 |

### 2.2. 环境模型规范

| 规范项 | 要求 | 目的 |
| :--- | :--- | :--- |
| **地形网格** | 建议使用高度图生成，并分块导出。 | 实现大规模、高细节的飞行区域。 |
| **天空盒** | 必须是大型立方体或球体，法线反转，并使用 HDR 贴图。 | 提供逼真的天空和环境光照。 |
| **碰撞模型** | 地形和重要建筑应提供简化的碰撞网格（例如 `.bullet` 格式），用于 PyBullet 碰撞检测。 | 确保碰撞检测的准确性和性能。 |

## 3. 物理引擎集成指南

本项目使用 **PyBullet** 进行刚体动力学模拟。

### 3.1. 飞行动力学模型

飞行动力学在 `src/physics_manager.py` 中实现，核心是 `apply_flight_forces` 方法。

*   **力 (Forces)**: 重力、推力、升力、阻力。
*   **力矩 (Moments)**: 滚转力矩 (Aileron)、俯仰力矩 (Elevator)、偏航力矩 (Rudder)。

**自定义飞行动力学**：我们禁用了 PyBullet 的默认重力，并手动计算和施加力，以实现更复杂的空气动力学效果，例如：

*   **迎角 (AoA) 计算**：通过飞机的速度向量和机身轴线计算。
*   **失速模拟**：当迎角超过 `stall_angle` 时，升力系数急剧下降。

开发者可以修改 `physics_manager.py` 中的参数（如 `mass`, `wing_area`, `cl_max`）和公式来调整飞行手感。

## 4. 性能优化要点

*   **视锥体剔除 (Frustum Culling)**: Panda3D 自动处理。
*   **渲染批次 (Draw Calls)**: 尽量合并静态网格，使用材质共享。
*   **LOD**：使用 `LODNode` 确保远处的模型使用低细节版本。

---
*作者：Manus AI*

